import logging
import re
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ConversationHandler,
    filters,
    ContextTypes
)

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
BOT_TOKEN = "8589316366:AAEc4u5WEfJIanTQfPKdHXM3M1TucC8p4xI"
ADMIN_CHAT_ID = 8499706905  # –í–∞—à ID –≤–º–µ—Å—Ç–æ username
PRIVATE_CHANNEL_LINK = "https://t.me/+4dcISEvpO61jMjRh"

# ========== –°–û–°–¢–û–Ø–ù–ò–Ø –î–ò–ê–õ–û–ì–ê ==========
NICKNAME, AGE, EXPERIENCE, USERNAME = range(4)

# ========== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–Ø ==========
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[
        logging.FileHandler('bot_log.txt', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# ========== –§–£–ù–ö–¶–ò–ò –ë–û–¢–ê ==========

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"""
    user = update.effective_user
    
    welcome_text = (
        "üéÆ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ Minecraft –ø—Ä–æ–µ–∫—Ç—É!*\n\n"
        "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É –∫–∞–Ω–∞–ª—É –æ—Ç–≤–µ—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤.\n\n"
        "üìù *–ü–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å:*\n"
        "–ö–∞–∫–æ–π —É —Ç–µ–±—è –∏–≥—Ä–æ–≤–æ–π –Ω–∏–∫–Ω–µ–π–º? (–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã)"
    )
    
    await update.message.reply_text(
        welcome_text,
        parse_mode='Markdown',
        reply_markup=InlineKeyboardMarkup([[
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")
        ]])
    )
    
    logger.info(f"üÜï –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} ({user.first_name}) –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥")
    return NICKNAME

async def get_nickname(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∏–∫–Ω–µ–π–º–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π"""
    user = update.effective_user
    nickname = update.message.text.strip()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –Ω–∏–∫–Ω–µ–π–º–∞
    if len(nickname) < 2:
        await update.message.reply_text(
            "‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –Ω–∏–∫–Ω–µ–π–º. –ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º:"
        )
        return NICKNAME
    
    if len(nickname) > 20:
        await update.message.reply_text(
            "‚ùå –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º. –ú–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä–æ—á–µ:"
        )
        return NICKNAME
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    if not re.match(r'^[a-zA-Z0-9_\-\s]+$', nickname):
        await update.message.reply_text(
            "‚ùå –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã –∏ —Å–∏–º–≤–æ–ª—ã _ -\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º:"
        )
        return NICKNAME
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    context.user_data['nickname'] = nickname
    context.user_data['user_id'] = user.id
    context.user_data['username'] = user.username
    context.user_data['full_name'] = user.full_name
    
    logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} —É–∫–∞–∑–∞–ª –Ω–∏–∫: {nickname}")
    
    await update.message.reply_text(
        "üìù *–í—Ç–æ—Ä–æ–π –≤–æ–ø—Ä–æ—Å:*\n"
        "–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç? (–¢–æ–ª—å–∫–æ —á–∏—Å–ª–æ –æ—Ç 10 –¥–æ 99)",
        parse_mode='Markdown'
    )
    
    return AGE

async def get_age(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
    user = update.effective_user
    age_text = update.message.text.strip()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–≤–µ–¥–µ–Ω–æ —á–∏—Å–ª–æ
    if not age_text.isdigit():
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 18)\n"
            "–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?"
        )
        return AGE
    
    age = int(age_text)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
    if age < 10:
        await update.message.reply_text(
            "‚ùå –ò–∑–≤–∏–Ω–∏, –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Å 10 –ª–µ—Ç.\n"
            "–ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ!"
        )
        return ConversationHandler.END
    
    if age > 99:
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (–¥–æ 99 –ª–µ—Ç).\n"
            "–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ?"
        )
        return AGE
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç
    context.user_data['age'] = age
    
    logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} —É–∫–∞–∑–∞–ª –≤–æ–∑—Ä–∞—Å—Ç: {age}")
    
    # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    keyboard = [
        [
            InlineKeyboardButton("‚úÖ –î–∞, –∏–≥—Ä–∞–ª(–∞)", callback_data="experience_yes"),
            InlineKeyboardButton("‚ùå –ù–µ—Ç, –Ω–µ –∏–≥—Ä–∞–ª(–∞)", callback_data="experience_no")
        ],
        [InlineKeyboardButton("üéÆ –ò–Ω–æ–≥–¥–∞ –∏–≥—Ä–∞–ª(–∞)", callback_data="experience_sometimes")]
    ]
    
    await update.message.reply_text(
        "üéÆ *–¢—Ä–µ—Ç–∏–π –≤–æ–ø—Ä–æ—Å:*\n"
        "–ò–≥—Ä–∞–ª –ª–∏ —Ç—ã —Ä–∞–Ω—å—à–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞—Ö –≤ Minecraft?\n"
        "(PvP, –≤—ã–∂–∏–≤–∞–Ω–∏–µ, –º–∏–Ω–∏-–∏–≥—Ä—ã –∏ —Ç.–¥.)",
        parse_mode='Markdown',
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    
    return EXPERIENCE

async def get_experience(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ–± –æ–ø—ã—Ç–µ"""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –æ–ø—ã—Ç–∞
    experience_map = {
        "experience_yes": "‚úÖ –î–∞, –µ—Å—Ç—å –æ–ø—ã—Ç",
        "experience_no": "‚ùå –ù–µ—Ç –æ–ø—ã—Ç–∞",
        "experience_sometimes": "üéÆ –ú–∞–ª–æ –æ–ø—ã—Ç–∞"
    }
    
    experience = experience_map.get(query.data, "–ù–µ —É–∫–∞–∑–∞–Ω–æ")
    context.user_data['experience'] = experience
    
    logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} —É–∫–∞–∑–∞–ª –æ–ø—ã—Ç: {experience}")
    
    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await query.edit_message_text(
        f"üéÆ *–û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç:* {experience}\n\n"
        f"üìù *–ß–µ—Ç–≤–µ—Ä—Ç—ã–π –≤–æ–ø—Ä–æ—Å:*\n"
        f"–ö–∞–∫–æ–π —É —Ç–µ–±—è —é–∑–µ—Ä–Ω–µ–π–º –≤ Telegram –¥–ª—è —Å–≤—è–∑–∏?\n"
        f"(–ù–∞–ø—Ä–∏–º–µ—Ä: @username –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ username)",
        parse_mode='Markdown'
    )
    
    return USERNAME

async def get_username(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —é–∑–µ—Ä–Ω–µ–π–º–∞ –¥–ª—è —Å–≤—è–∑–∏"""
    user = update.effective_user
    contact_username = update.message.text.strip()
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —é–∑–µ—Ä–Ω–µ–π–º–∞
    if contact_username.startswith("@"):
        contact_username = contact_username[1:]  # –£–±–∏—Ä–∞–µ–º @ –µ—Å–ª–∏ –µ—Å—Ç—å
    
    if not contact_username:
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏ —Å–≤–æ–π —é–∑–µ—Ä–Ω–µ–π–º.\n"
            "–ö–∞–∫ —Å —Ç–æ–±–æ–π —Å–≤—è–∑–∞—Ç—å—Å—è –≤ Telegram?"
        )
        return USERNAME
    
    # –î–æ–±–∞–≤–ª—è–µ–º @ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    display_username = f"@{contact_username}"
    context.user_data['contact'] = display_username
    context.user_data['timestamp'] = datetime.now().strftime("%d.%m.%Y %H:%M:%S")
    
    logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} —É–∫–∞–∑–∞–ª –∫–æ–Ω—Ç–∞–∫—Ç: {display_username}")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    user_data = context.user_data
    
    admin_message = (
        "üÜï *–ù–û–í–ê–Ø –ó–ê–Ø–í–ö–ê –ù–ê –î–û–°–¢–£–ü*\n"
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n"
        f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {user.mention_markdown_v2()}\n"
        f"üÜî *ID:* `{user.id}`\n"
        f"üìõ *–ò–≥—Ä–æ–≤–æ–π –Ω–∏–∫:* {user_data['nickname']}\n"
        f"üéÇ *–í–æ–∑—Ä–∞—Å—Ç:* {user_data['age']} –ª–µ—Ç\n"
        f"üéÆ *–û–ø—ã—Ç –≤ MC:* {user_data['experience']}\n"
        f"üìû *–î–ª—è —Å–≤—è–∑–∏:* {display_username}\n"
        f"üïê *–í—Ä–µ–º—è –ø–æ–¥–∞—á–∏:* {user_data['timestamp']}\n"
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    )
    
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –¥–ª—è MarkdownV2
    admin_message = admin_message.replace(".", "\\.").replace("-", "\\-").replace("(", "\\(").replace(")", "\\)")
    
    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    keyboard = [
        [
            InlineKeyboardButton("‚úÖ –û–î–û–ë–†–ò–¢–¨", callback_data=f"approve_{user.id}"),
            InlineKeyboardButton("‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨", callback_data=f"reject_{user.id}")
        ],
        [
            InlineKeyboardButton("üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é", 
                               url=f"tg://user?id={user.id}")
        ]
    ]
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        await context.bot.send_message(
            chat_id=ADMIN_CHAT_ID,
            text=admin_message,
            parse_mode='MarkdownV2',
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        
        logger.info(f"üì§ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {ADMIN_CHAT_ID}")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: {e}")
        
        # –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
        print("\n" + "üîî " + "="*50)
        print("–ù–ï–û–¢–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ó–ê–Ø–í–ö–ê (–∞–¥–º–∏–Ω –Ω–µ –ø–æ–ª—É—á–∏–ª):")
        print(f"ID: {user.id}")
        print(f"–ò–º—è: {user.full_name}")
        print(f"–ù–∏–∫: {user_data['nickname']}")
        print(f"–í–æ–∑—Ä–∞—Å—Ç: {user_data['age']}")
        print(f"–û–ø—ã—Ç: {user_data['experience']}")
        print(f"–ö–æ–Ω—Ç–∞–∫—Ç: {display_username}")
        print("="*50 + "\n")
    
    # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await update.message.reply_text(
        "üéâ *–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–≤–µ—Ç—ã!*\n\n"
        "‚úÖ –¢–≤–æ—è –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.\n"
        "‚è≥ –û–∂–∏–¥–∞–π —Ä–µ—à–µ–Ω–∏—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n\n"
        "üì¢ *–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ø–∏—Å–∞–≤ /status*",
        parse_mode='Markdown'
    )
    
    return ConversationHandler.END

async def admin_action(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    data = query.data
    
    logger.info(f"üëë –ê–¥–º–∏–Ω {user.id} –Ω–∞–∂–∞–ª: {data}")
    
    if data.startswith("approve_"):
        target_user_id = int(data.split("_")[1])
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞
        original_text = query.message.text
        approved_text = original_text + "\n\n‚úÖ *–°–¢–ê–¢–£–°: –û–î–û–ë–†–ï–ù–û*"
        
        await query.edit_message_text(
            text=approved_text,
            parse_mode='MarkdownV2'
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        try:
            await context.bot.send_message(
                chat_id=target_user_id,
                text=(
                    "üéâ *–ü–û–ó–î–†–ê–í–õ–Ø–ï–ú!*\n\n"
                    "‚úÖ –¢–≤–æ—è –∑–∞—è–≤–∫–∞ –Ω–∞ –¥–æ—Å—Ç—É–ø *–û–î–û–ë–†–ï–ù–ê* –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!\n\n"
                    "üîó *–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª:*\n"
                    f"{PRIVATE_CHANNEL_LINK}\n\n"
                    "üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à Minecraft –ø—Ä–æ–µ–∫—Ç!\n"
                    "üéÆ –ü—Ä–∏—è—Ç–Ω–æ–π –∏–≥—Ä—ã –∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–≥–æ –≤—ã–∂–∏–≤–∞–Ω–∏—è!"
                ),
                parse_mode='Markdown',
                disable_web_page_preview=True
            )
            
            logger.info(f"‚úÖ –°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_user_id}")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_user_id}: {e}")
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ–± –æ—à–∏–±–∫–µ
            await query.message.reply_text(
                f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é `{target_user_id}`\n"
                "–í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞.",
                parse_mode='MarkdownV2'
            )
    
    elif data.startswith("reject_"):
        target_user_id = int(data.split("_")[1])
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞
        original_text = query.message.text
        rejected_text = original_text + "\n\n‚ùå *–°–¢–ê–¢–£–°: –û–¢–ö–õ–û–ù–ï–ù–û*"
        
        await query.edit_message_text(
            text=rejected_text,
            parse_mode='MarkdownV2'
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏
        try:
            await context.bot.send_message(
                chat_id=target_user_id,
                text=(
                    "‚ö†Ô∏è *–£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ü–û –ó–ê–Ø–í–ö–ï*\n\n"
                    "‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ç–≤–æ—è –∑–∞—è–≤–∫–∞ –Ω–∞ –¥–æ—Å—Ç—É–ø –±—ã–ª–∞ *–û–¢–ö–õ–û–ù–ï–ù–ê* –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n\n"
                    "üìã *–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:*\n"
                    "‚Ä¢ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö\n"
                    "‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è\n"
                    "‚Ä¢ –î—Ä—É–≥–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–±–æ—Ä–∞\n\n"
                    "üîÑ –ï—Å–ª–∏ —Å—á–∏—Ç–∞–µ—à—å, —á—Ç–æ —ç—Ç–æ –æ—à–∏–±–∫–∞ - —Å–≤—è–∂–∏—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."
                ),
                parse_mode='Markdown'
            )
            
            logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_user_id}")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è {target_user_id}: {e}")

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω–∞ –¥–∏–∞–ª–æ–≥–∞"""
    user = update.effective_user
    
    await update.message.reply_text(
        "‚ùå –î–∏–∞–ª–æ–≥ –æ—Ç–º–µ–Ω–µ–Ω.\n"
        "–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞ - –Ω–∞–ø–∏—à–∏ /start",
        reply_markup=InlineKeyboardMarkup([[
            InlineKeyboardButton("üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ", callback_data="restart")
        ]])
    )
    
    logger.info(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} –æ—Ç–º–µ–Ω–∏–ª –¥–∏–∞–ª–æ–≥")
    return ConversationHandler.END

async def status(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏"""
    user = update.effective_user
    
    await update.message.reply_text(
        "üìä *–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏*\n\n"
        "–ï—Å–ª–∏ —Ç—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª(–∞) –∑–∞—è–≤–∫—É:\n"
        "‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∏–ª —Ç–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã\n"
        "‚è≥ –ó–∞—è–≤–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏\n"
        "üì® –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–¥–µ—Ç —Ç–µ–±–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n\n"
        "‚ùì *–ù–µ –ø—Ä–∏—à–µ–ª –æ—Ç–≤–µ—Ç?*\n"
        "‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ç—ã –Ω–∞—á–∞–ª(–∞) –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º\n"
        "‚Ä¢ –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è\n"
        "‚Ä¢ –ù–∞–ø–∏—à–∏ /start –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏",
        parse_mode='Markdown'
    )
    
    logger.info(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å—Ç–∞—Ç—É—Å")

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏"""
    await update.message.reply_text(
        "ü§ñ *–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É*\n\n"
        "üìù *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
        "/start - –ù–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏\n"
        "/status - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏\n"
        "/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n"
        "‚ùì *–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?*\n"
        "1. –ù–∞–∂–º–∏ /start –∏ –æ—Ç–≤–µ—Ç—å –Ω–∞ 4 –≤–æ–ø—Ä–æ—Å–∞\n"
        "2. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∏—Ç —Ç–≤–æ—é –∑–∞—è–≤–∫—É\n"
        "3. –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–±–µ –ø—Ä–∏–¥–µ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª\n\n"
        "‚ö†Ô∏è *–í–∞–∂–Ω–æ:*\n"
        "‚Ä¢ –û—Ç–≤–µ—á–∞–π —á–µ—Å—Ç–Ω–æ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã\n"
        "‚Ä¢ –£–±–µ–¥–∏—Å—å, —á—Ç–æ –±–æ—Ç –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å —Ç–µ–±–µ\n"
        "‚Ä¢ –û–∂–∏–¥–∞–π —Ä–µ—à–µ–Ω–∏—è –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö",
        parse_mode='Markdown'
    )

# ========== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ==========
def main() -> None:
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∏–∞–ª–æ–≥–∞
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            NICKNAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_nickname)],
            AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_age)],
            EXPERIENCE: [CallbackQueryHandler(get_experience, pattern="^experience_")],
            USERNAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_username)],
        },
        fallbacks=[
            CommandHandler("cancel", cancel),
            CallbackQueryHandler(cancel, pattern="^cancel$")
        ],
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(conv_handler)
    application.add_handler(CommandHandler("status", status))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(admin_action, pattern="^(approve_|reject_)"))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("\n" + "="*60)
    print("üéÆ Minecraft Access Bot v2.0")
    print("="*60)
    print(f"üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: {ADMIN_CHAT_ID}")
    print(f"üîó –ö–∞–Ω–∞–ª: {PRIVATE_CHANNEL_LINK}")
    print("="*60)
    print("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    print("üì± –ù–∞–ø–∏—à–∏—Ç–µ /start –≤ Telegram –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
    print("="*60 + "\n")
    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

# ========== –ó–ê–ü–£–°–ö ==========
if __name__ == '__main__':
    main()
